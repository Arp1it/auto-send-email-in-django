{% extends 'main.html' %}

{% block body %}
<div class="container my-3">
  <div class="my-3">
    <h2>Emails Details filled Here</h2>
  </div>
  <!-- <form class="container my-3" method='post' action="/storing">{% csrf_token %} -->
    <div class="mb-3">Title of Message</label>
      <input type="text" name="titleofe" class="form-control" id="text" placeholder="Title of message" aria-describedby="text" required />
    </div>
    <!-- <div class="mb-3">
      <label for="text" class="form-label">Your Message</label>
      <input type="text" class="form-control" id="text" aria-describedby="text" required />
    </div> -->
    <div class="mb-3">
      <label for="floatingTextarea">Your Message</label>
      <textarea class="form-control" name="yourmsg" placeholder="Write your message Here" rows="3" id="floatingTextarea" required></textarea>
    </div>
    <div class="mb-3">
      <label for="exampleInputEmail1" class="form-label">Receivers Email address</label>
      <input type="email" name="receiveremail" class="form-control" id="exampleInputEmail1" placeholder="example12@gmail.com" aria-describedby="emailHelp" multiple required />
    </div>
    <div class="mb-3">
      <label for="sendingdate1" class="form-label">Sending Date and Time</label>
      <input type="datetime-local" name="sendingdate" class="form-control" id="sendingdate1"
        aria-describedby="emailHelp" required />
    </div>
    <div class="mb-3 form-check">
      <input type="checkbox" class="form-check-input" id="exampleCheck1" required />
      <label class="form-check-label" for="exampleCheck1">Terms and condition applied</label>
    </div>
    <button type="submit" class="btn btn-primary" onclick="sendMessage()">Submit</button>
  <!-- </form> -->
</div>

<div class="my-3">
  <hr />
</div>

<div id="mailwaitinginqueue">
{% for i in fetcher %}

<div class="my-2 container" id="{{i.id}}">
  <div class="my-3">
    <h2>Your email sending details</h2>
  </div>
  <div class="card">
    <div class="card-header">
      {{i.title}}
    </div>
    <div class="card-body">
      <blockquote class="blockquote mb-0">
        <p><b>To:</b> {{i.receiveremail}}</i></p>
        <p><b>Message:</b> {{i.msg}}</i></p>
        <footer class="blockquote-footer mt-2">Send on<cite title="Source Title"> {{i.sendingdate}}</cite></footer>
      </blockquote>
    </div>
    <a href="/del/{{i.id}}" type="button" class="btn btn-outline-danger">Delete</a>
  </div>
</div>

{% endfor %}
</div>

<script>
  // frontend.js
    let url = "ws://" + window.location.host + "/ws/frontend_updates/"
    let sender = "{{request.user.id}}"

    let socket = new WebSocket(url)

    // console.log(sender)

    socket.onmessage = function(event) {
      let message = JSON.parse(event.data);
        if (message.payloads){
          updateUI(message.payloads.msg, message.payloads.reemail, message.payloads.title, message.payloads.sedat, message.payloads.mail_id)
        }

        else{
        // Handle the received message, e.g., update the UI
        // console.log("Received message from server:", message);
        document.getElementById(message).remove()
        // For example, update a DOM element to reflect the deletion
        // document.getElementById("update-message").innerText = "Data deleted from the database";
        }
    };

    socket.onopen = function() {
        console.log("WebSocket connection established");
    };

    socket.onclose = function(event) {
        console.log("WebSocket connection closed:", event.reason);
    };

    socket.onerror = function(error) {
        console.error("WebSocket error:", error);
    };


  const sendMessage = () =>{
    let title = document.getElementById("text")
    let message = document.getElementById("floatingTextarea")
    let receiveremail = document.getElementById("exampleInputEmail1")
    let sendingdate = document.getElementById("sendingdate1")
    
    // console.log(title.value, message.value, receiveremail.value, sendingdate.value, sender)

    socket.send(JSON.stringify({"title":title.value, "message": message.value, "recemail": receiveremail.value, "sedate":sendingdate.value, sende:sender}))

    title.value = ""
    message.value = ""
    receiveremail.value = ""
    sendingdate.value = ""

  }

  const updateUI = (message, reemail, title, sedate, mailid) =>{
    console.log(`Update ui - ${message}, ${reemail}, ${title}, ${sedate}, ${mailid}`)

    document.getElementById("mailwaitinginqueue").innerHTML += `<div class="my-2 container" id="${mailid}">
  <div class="my-3">
    <h2>Your email sending details</h2>
  </div>
  <div class="card">
    <div class="card-header">
      ${title}
    </div>
    <div class="card-body">
      <blockquote class="blockquote mb-0">
        <p><b>To:</b> ${reemail}</i></p>
        <p><b>Message:</b> ${message}</i></p>
        <footer class="blockquote-footer mt-2">Send on<cite title="Source Title"> ${sedate}</cite></footer>
      </blockquote>
    </div>
    <a href="/del/${mailid}" type="button" class="btn btn-outline-danger">Delete</a>
  </div>
</div>`
  }

</script>

{% endblock %}